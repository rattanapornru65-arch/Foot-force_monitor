<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Mali&display=swap" rel="stylesheet">
  <title>Foot Pressure Monitor</title>
  <style>
    body {
      font-family: 'Mali', cursive;
      background-color: #e0f2ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 1rem;
      box-sizing: border-box;
    }

    h1 {
      color: #007acc;
      margin-bottom: 0.5rem;
      text-align: center;
      font-size: clamp(1.2rem, 2vw, 2rem);
    }

    .button-thai {
      font-family: 'Mali', cursive;
    }

    button {
      background-color: #33CCCC;
      color: #000000;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      font-size: clamp(0.9rem, 1.5vw, 1.1rem);
      cursor: pointer;
      margin: 0.3rem;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0099cc;
      color: white;
    }

    .foot-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      width: 100%;
      max-width: 900px;
      margin-top: 1.5rem;
    }

    .foot {
      position: relative;
      width: 100%;
      max-width: 320px;
    }

    .foot img {
      width: 100%;
      height: auto;
      border: 4px solid #b3e0ff;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .sensor {
      position: absolute;
      background: rgba(245, 15, 103, 0.8);
      color: white;
      font-size: clamp(0.7rem, 1.5vw, 1rem);
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
    }

    /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á sensor ‡πÅ‡∏ö‡∏ö‡∏≠‡∏¥‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (‡πÉ‡∏ä‡πâ %) */
    #L1 { top: 5%; right: 27%; }
    #L2 { top: 30%; right: 30%; }
    #L3 { top: 45%; right: 60%; }
    #L4 { top: 80%; left: 45%; }

    #R1 { top: 5%; right: 60%; }
    #R2 { top: 30%; left: 30%; }
    #R3 { top: 45%; right: 25%; }
    #R4 { top: 80%; right: 45%; }

    footer {
      margin-top: 2rem;
      color: #666;
      font-size: 0.8rem;
      text-align: center;
    }

    /* -------- Responsive -------- */
    @media (max-width: 768px) {
      .foot-container {
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }
      .foot {
        max-width: 80%;
      }
      button {
        width: 90%;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.1rem;
      }
      button {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
      .sensor {
        font-size: 0.75rem;
        padding: 3px 6px;
      }
    }
  </style>
</head>
<body>

<h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h1>

<div style="text-align: center;">
  <button class="button-thai" onclick="connectLeftFoot()">üîµ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢</button>
  <button class="button-thai" onclick="connectRightFoot()">üîµ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤</button>
</div>

<div style="margin: 20px; text-align: center;">
  <button class="button-thai" onclick="startRecording()">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (1 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
  <button class="button-thai" onclick="stopRecording()" id="stopBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="button-thai" onclick="downloadCSV()" id="downloadBtn" style="display:none;">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
</div>

<div class="foot-container">
  <div class="foot">
    <img src="./img/left.png" alt="Left Foot">
    <div class="sensor" id="L1">0</div>
    <div class="sensor" id="L2">0</div>
    <div class="sensor" id="L3">0</div>
    <div class="sensor" id="L4">0</div>
  </div>

  <div class="foot">
    <img src="./img/right.png" alt="Right Foot">
    <div class="sensor" id="R1">0</div>
    <div class="sensor" id="R2">0</div>
    <div class="sensor" id="R3">0</div>
    <div class="sensor" id="R4">0</div>
  </div>
</div>

<footer>
  ¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ù‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤ | ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤
</footer>

<script>
  let recording = false;
  let dataLog = [];
  let recordTimer;

  let leftDevice, leftCharacteristic;
  let rightDevice, rightCharacteristic;

  let lastLeftData = Array(4).fill(0).map(val => val.toFixed(2));
  let lastRightData = Array(4).fill(0).map(val => val.toFixed(2));

  async function connectLeftFoot() {
    try {
      leftDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: "ESP32-LeftFoot" }],
        optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
      });
      const leftServer = await leftDevice.gatt.connect();
      const leftService = await leftServer.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
      leftCharacteristic = await leftService.getCharacteristic("87654321-4321-4321-4321-abcdefabcdef");
      leftCharacteristic.startNotifications();
      leftCharacteristic.addEventListener("characteristicvaluechanged", handleLeftFootData);
      alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
    } catch (error) {
      console.error("BLE Error:", error);
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
  }

  async function connectRightFoot() {
    try {
      rightDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: "ESP32-RightFoot" }],
        optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
      });
      const rightServer = await rightDevice.gatt.connect();
      const rightService = await rightServer.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
      rightCharacteristic = await rightService.getCharacteristic("87654321-4321-4321-4321-abcdefabcdef");
      rightCharacteristic.startNotifications();
      rightCharacteristic.addEventListener("characteristicvaluechanged", handleRightFootData);
      alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
    } catch (error) {
      console.error("BLE Error:", error);
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
  }

  function handleLeftFootData(event) {
    const value = event.target.value;
    const dataView = new DataView(value.buffer);
    let forceValues = [];
    for (let i = 0; i < value.byteLength / 4; i++) {
      forceValues.push(dataView.getFloat32(i * 4, true));
    }

    lastLeftData = forceValues.map(val => val.toFixed(2));

    const displayIds = ["L1", "L2", "L3", "L4"];
    for (let i = 0; i < forceValues.length && i < displayIds.length; i++) {
      let id = displayIds[i];
      let val = forceValues[i].toFixed(2);
      document.getElementById(id).innerText = `${val} N`;
      document.getElementById(id).style.backgroundColor = getColorByPressure(val);
    }
  }

  function handleRightFootData(event) {
    const value = event.target.value;
    const dataView = new DataView(value.buffer);
    let forceValues = [];
    for (let i = 0; i < value.byteLength / 4; i++) {
      forceValues.push(dataView.getFloat32(i * 4, true));
    }

    lastRightData = forceValues.map(val => val.toFixed(2));

    const displayIds = ["R1", "R2", "R3", "R4"];
    for (let i = 0; i < forceValues.length && i < displayIds.length; i++) {
      let id = displayIds[i];
      let val = forceValues[i].toFixed(2);
      document.getElementById(id).innerText = `${val} N`;
      document.getElementById(id).style.backgroundColor = getColorByPressure(val);
    }
  }

  function getColorByPressure(value) {
    value = parseFloat(value);
    if (value <= 5.0) return "#66ccff";
    if (value <= 50.0) return "#33cc33";
    if (value <= 80.0) return "#ff9933";
    return "#ff3333";
  }

  function startRecording() {
    if (!leftCharacteristic || !rightCharacteristic) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Bluetooth ‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
      return;
    }

    dataLog = [["L1 (N)", "L2 (N)", "L3 (N)", "L4 (N)", "R1 (N)", "R2 (N)", "R3 (N)", "R4 (N)"]];
    recording = true;
    document.getElementById("stopBtn").disabled = false;
    document.getElementById("downloadBtn").style.display = "none";
    alert("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (1 ‡∏ô‡∏≤‡∏ó‡∏µ)");

    recordTimer = setInterval(() => {
      dataLog.push([...lastLeftData, ...lastRightData]);
    }, 100);

    setTimeout(() => {
      stopRecording();
      alert("‡∏Ñ‡∏£‡∏ö 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    }, 60 * 1000);
  }

  function stopRecording() {
    if (!recording) return;
    recording = false;
    clearInterval(recordTimer);
    document.getElementById("stopBtn").disabled = true;
    document.getElementById("downloadBtn").style.display = "inline-block";
    alert("‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
  }

  function downloadCSV() {
    if (dataLog.length <= 1) {
      alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
      return;
    }
    let csvContent = dataLog.map(row => row.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `foot_data_${new Date().toISOString().replace(/[:.]/g, "-")}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
